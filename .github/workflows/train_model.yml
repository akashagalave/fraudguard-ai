name: FraudGuard Model Training

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Why retraining was triggered"
        required: false
        default: "manual"
      alert:
        description: "Alert name"
        required: false
        default: "none"

  schedule:
    - cron: "0 2 * * 0"   # weekly safety retrain

jobs:
  train:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      MLFLOW_TRACKING_URI: https://dagshub.com/akashagalaveaaa1/fraudguard-ai.mlflow
      MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_TOKEN }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}

      # retrain protection
      COOLDOWN_HOURS: 24

    steps:
      # =========================
      # 1Ô∏è‚É£ Checkout
      # =========================
      - uses: actions/checkout@v4

      # =========================
      # 2Ô∏è‚É£ Python
      # =========================
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # =========================
      # 3Ô∏è‚É£ Log trigger context
      # =========================
      - name: Log retrain context
        run: |
          echo "üîÅ Retraining trigger reason: ${{ github.event.inputs.reason }}"
          echo "üö® Alert: ${{ github.event.inputs.alert }}"
          echo "üïí Event type: ${{ github.event_name }}"

      # =========================
      # 4Ô∏è‚É£ Install dependencies
      # =========================
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r dev-requirements.txt
          pip install -e .
          pip install dvc[s3] mlflow dagshub

      # =========================
      # 5Ô∏è‚É£ AWS
      # =========================
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # =========================
      # 6Ô∏è‚É£ Data fetch
      # =========================
      - name: Fetch external data
        run: |
          aws s3 cp s3://fraudguard-raw-data/data/external/ data/external/ --recursive

      - name: DVC Pull
        run: dvc pull

      # =========================
      # 7Ô∏è‚É£ Drift detection (HARD GATE)
      # =========================
      - name: Detect data drift
        run: |
          python scripts/drift_detector.py

          if [ -f retrain.flag ]; then
            echo "üö® Drift detected ‚Äî retraining allowed"
          else
            if [ "${{ github.event_name }}" = "schedule" ]; then
              echo "üóìÔ∏è Scheduled retrain ‚Äî proceeding anyway"
            else
              echo "‚úÖ No drift & not scheduled ‚Äî skipping retrain"
              exit 0
            fi
          fi

      # =========================
      # 8Ô∏è‚É£ Cooldown protection
      # =========================
      - name: Retrain cooldown check
        run: |
          LAST_RUN_FILE=".last_retrain"

          if [ -f "$LAST_RUN_FILE" ]; then
            LAST_RUN=$(cat $LAST_RUN_FILE)
            NOW=$(date +%s)
            DIFF_HOURS=$(( (NOW - LAST_RUN) / 3600 ))

            if [ "$DIFF_HOURS" -lt "$COOLDOWN_HOURS" ]; then
              echo "‚è≥ Cooldown active ($DIFF_HOURS h < $COOLDOWN_HOURS h). Exiting."
              exit 0
            fi
          fi

          date +%s > $LAST_RUN_FILE

      # =========================
      # 9Ô∏è‚É£ Retrain
      # =========================
      - name: Retrain model
        run: |
          echo "üî• Starting model retraining"
          dvc repro

      # =========================
      # üîü Push artifacts
      # =========================
      - name: Push artifacts
        run: dvc push
