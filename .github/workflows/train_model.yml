name: FraudGuard Model Training

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Why retraining was triggered"
        required: false
        default: "manual"
      alert:
        description: "Alert name"
        required: false
        default: "none"

  schedule:
    - cron: "0 2 * * 0" # Weekly retrain

jobs:
  train:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      MLFLOW_TRACKING_URI: https://dagshub.com/akashagalaveaaa1/fraudguard-ai.mlflow
      MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_TOKEN }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
      COOLDOWN_HOURS: 24

    outputs:
      model_ready: ${{ steps.set-output.outputs.model_ready }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          pip install dvc[s3] mlflow dagshub

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Restore retrain cooldown cache
        uses: actions/cache@v4
        with:
          path: .retrain-cache
          key: retrain-${{ github.repository }}

      - name: Detect data drift
        id: drift
        run: |
          python scripts/drift_detector.py || true

          if [ -f retrain.flag ]; then
            echo "DRIFT=true" >> $GITHUB_ENV
          else
            echo "DRIFT=false" >> $GITHUB_ENV
          fi

      - name: Cooldown check
        run: |
          mkdir -p .retrain-cache
          LAST_RUN_FILE=.retrain-cache/last_run

          NOW=$(date +%s)

          if [ -f "$LAST_RUN_FILE" ]; then
            LAST=$(cat $LAST_RUN_FILE)
            DIFF=$(( (NOW - LAST) / 3600 ))

            if [ "$DIFF" -lt "$COOLDOWN_HOURS" ] && [ "$DRIFT" != "true" ] && [ "${{ github.event_name }}" != "schedule" ]; then
              echo "Cooldown active â€” skipping retrain"
              exit 0
            fi
          fi

          echo $NOW > $LAST_RUN_FILE

      - name: DVC Pull
        run: dvc pull

      - name: Retrain model
        run: dvc repro

      - name: Push artifacts
        run: dvc push

      - name: Set output
        id: set-output
        run: echo "model_ready=true" >> $GITHUB_OUTPUT
