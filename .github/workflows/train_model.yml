name: FraudGuard Model Training

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Why retraining was triggered"
        required: false
        default: "manual"
      alert:
        description: "Alert name"
        required: false
        default: "none"

  schedule:
    - cron: "0 2 * * 0"  

jobs:
  train:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      DAGSHUB_USER_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      MLFLOW_TRACKING_URI: https://dagshub.com/akashagalaveaaa1/fraudguard-ai.mlflow
      MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_TOKEN }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}

   
      COOLDOWN_HOURS: 24

    steps:

      - uses: actions/checkout@v4


      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"


      - name: Log retrain context
        run: |
          echo " Retraining trigger reason: ${{ github.event.inputs.reason }}"
          echo " Alert: ${{ github.event.inputs.alert }}"
          echo " Event type: ${{ github.event_name }}"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          pip install dvc[s3] mlflow dagshub


      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}


      - name: Fetch external data
        run: |
          aws s3 cp s3://fraudguard-raw-data/data/external/ data/external/ --recursive

      - name: DVC Pull
        run: dvc pull


      - name: Detect data drift
        run: |
          python scripts/drift_detector.py

          if [ -f retrain.flag ]; then
            echo " Drift detected — retraining allowed"
          else
            if [ "${{ github.event_name }}" = "schedule" ]; then
              echo " Scheduled retrain — proceeding anyway"
            else
              echo " No drift & not scheduled — skipping retrain"
              exit 0
            fi
          fi


      - name: Retrain cooldown check
        run: |
          LAST_RUN_FILE=".last_retrain"

          if [ -f "$LAST_RUN_FILE" ]; then
            LAST_RUN=$(cat $LAST_RUN_FILE)
            NOW=$(date +%s)
            DIFF_HOURS=$(( (NOW - LAST_RUN) / 3600 ))

            if [ "$DIFF_HOURS" -lt "$COOLDOWN_HOURS" ]; then
              echo " Cooldown active ($DIFF_HOURS h < $COOLDOWN_HOURS h). Exiting."
              exit 0
            fi
          fi

          date +%s > $LAST_RUN_FILE


      - name: Retrain model
        run: |
          echo "Starting model retraining"
          dvc repro


      - name: Push artifacts
        run: dvc push
