name: FraudGuard Full CI-CD Pipeline

on:
  workflow_run:
    workflows: ["FraudGuard Model Training"]
    types:
      - completed

  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 199964507152.dkr.ecr.us-east-1.amazonaws.com
  CLUSTER_NAME: fraudguard-eks
  NAMESPACE: fraudguard

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          pip install mlflow dagshub dvc[s3]

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: DVC Pull Artifacts
        run: dvc pull

      - name: Validate Model Quality
        run: python scripts/model_quality_check.py

      - name: Promote Model to Production
        run: python scripts/promote_model.py

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Images
        run: |
          TAG=${{ github.sha }}

          docker build -t fastapi -f serving/Dockerfile .
          docker tag fastapi $ECR_REGISTRY/fraudguard-fastapi:$TAG
          docker push $ECR_REGISTRY/fraudguard-fastapi:$TAG

          docker build -t producer -f services/producer/Dockerfile .
          docker tag producer $ECR_REGISTRY/fraudguard-producer:$TAG
          docker push $ECR_REGISTRY/fraudguard-producer:$TAG

          docker build -t consumer -f services/consumer/Dockerfile .
          docker tag consumer $ECR_REGISTRY/fraudguard-consumer:$TAG
          docker push $ECR_REGISTRY/fraudguard-consumer:$TAG

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name $CLUSTER_NAME

      - name: Deploy Core Infrastructure
        run: |
          kubectl apply -n $NAMESPACE -f infrastructure/kubernetes/redis/
          kubectl apply -n $NAMESPACE -f infrastructure/kubernetes/kafka/

      - name: Deploy Stable Services
        run: |
          kubectl apply -n $NAMESPACE -f infrastructure/kubernetes/canary/fastapi-stable-deployment.yaml
          kubectl apply -n $NAMESPACE -f infrastructure/kubernetes/canary/fastapi-stable-service.yaml
          kubectl apply -n $NAMESPACE -f infrastructure/kubernetes/canary/ingress-stable.yaml

      - name: Deploy Workers
        run: |
          kubectl apply -n $NAMESPACE -f services/alert-worker/
          kubectl apply -n $NAMESPACE -f services/shap-worker/

      - name: Apply ServiceMonitors
        run: |
          kubectl apply -n $NAMESPACE -f infrastructure/kubernetes/monitoring/

      - name: Canary Deployment (Manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          kubectl apply -n $NAMESPACE -f infrastructure/kubernetes/canary/fastapi-canary-deployment.yaml
          kubectl apply -n $NAMESPACE -f infrastructure/kubernetes/canary/fastapi-canary-service.yaml
          kubectl apply -n $NAMESPACE -f infrastructure/kubernetes/canary/ingress-canary.yaml
